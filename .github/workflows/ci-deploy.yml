name: CI + Build Images + Deploy (k3s)

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: prod-main
  cancel-in-progress: true

env:
  IMAGE_PHP: ghcr.io/norrim/my-cv-php
  IMAGE_NGINX: ghcr.io/norrim/my-cv-nginx

jobs:
  ci-docker:
    name: CI Docker (prod-like)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build & start stack
        run: docker compose up -d --build

      - name: Wait for DB
        run: |
          for i in {1..40}; do
            docker compose exec -T db pg_isready -U symfony -d app && exit 0
            sleep 2
          done
          docker compose logs db
          exit 1

      - name: Install dependencies (container)
        run: docker compose exec -T php composer install --no-interaction --prefer-dist

      - name: QA + Tests (container)
        run: make test EXEC_TTY=-T

      - name: Tear down
        if: always()
        run: docker compose down -v --remove-orphans

  build-and-push:
    name: Build & Push images (GHCR)
    runs-on: ubuntu-latest
    needs: [ci-docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push PHP
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/php/Dockerfile.prod
          push: true
          tags: |
            ${{ env.IMAGE_PHP }}:prod
            ${{ env.IMAGE_PHP }}:${{ github.sha }}

      - name: Build & push Nginx
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/nginx/Dockerfile.prod
          push: true
          tags: |
            ${{ env.IMAGE_NGINX }}:prod
            ${{ env.IMAGE_NGINX }}:${{ github.sha }}

  deploy-k3s:
    name: Deploy to k3s (VPS)
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy over SSH (kubectl apply + rollout + secrets)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            cd "${{ secrets.VPS_PATH }}"

            echo "== BEFORE =="
            pwd
            ls -la
            git rev-parse HEAD
            git log -1 --oneline

            git fetch --all
            git reset --hard origin/main

            echo "== AFTER =="
            git rev-parse HEAD
            git log -1 --oneline
            git status

            echo "== APPLY K8S SECRETS =="
            # Postgres
            kubectl -n cv-prod create secret generic postgres-secret \
              --from-literal=POSTGRES_DB='${{ secrets.POSTGRES_DB }}' \
              --from-literal=POSTGRES_USER='${{ secrets.POSTGRES_USER }}' \
              --from-literal=POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # pgAdmin
            kubectl -n cv-prod create secret generic pgadmin-secret \
              --from-literal=PGADMIN_DEFAULT_EMAIL='${{ secrets.PGADMIN_EMAIL }}' \
              --from-literal=PGADMIN_DEFAULT_PASSWORD='${{ secrets.PGADMIN_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # RabbitMQ (si tu l'utilises)
            kubectl -n cv-prod create secret generic rabbitmq-secret \
              --from-literal=RABBITMQ_DEFAULT_USER='${{ secrets.RABBITMQ_USER }}' \
              --from-literal=RABBITMQ_DEFAULT_PASS='${{ secrets.RABBITMQ_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # Symfony app env (cv-secrets)
            kubectl -n cv-prod create secret generic cv-secrets \
              --from-literal=APP_SECRET='${{ secrets.APP_SECRET }}' \
              --from-literal=DATABASE_URL='${{ secrets.DATABASE_URL }}' \
              --from-literal=MESSENGER_TRANSPORT_DSN='${{ secrets.MESSENGER_TRANSPORT_DSN }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            echo "== APPLY MANIFESTS =="
            kubectl apply -f k8s/prod

            echo "== RESTART (reload env) =="
            kubectl -n cv-prod rollout restart deploy/postgres deploy/rabbitmq deploy/php deploy/nginx deploy/pgadmin || true

            echo "== WAIT =="
            kubectl -n cv-prod rollout status deploy/php --timeout=180s
            kubectl -n cv-prod rollout status deploy/nginx --timeout=180s
